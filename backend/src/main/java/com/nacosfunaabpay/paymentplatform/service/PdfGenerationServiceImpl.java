package com.nacosfunaabpay.paymentplatform.service;

import com.lowagie.text.DocumentException;
import org.aspectj.apache.bcel.util.ClassPath;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.util.FileCopyUtils;
import org.springframework.util.ResourceUtils;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;
import org.xhtmlrenderer.pdf.ITextRenderer;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.util.Base64;

@Service
public class PdfGenerationServiceImpl implements PdfGenerationService {

    private static final Logger logger = LoggerFactory.getLogger(PdfGenerationService.class);

    private final TemplateEngine templateEngine;

    private static final String LOGO_URL = "data:image/jpeg;base64,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";

    public PdfGenerationServiceImpl(TemplateEngine templateEngine) {
        this.templateEngine = templateEngine;
    }

    public byte[] generatePdf(String templateName, Context context) throws DocumentException, IOException {
        try {
            logger.info("Generating PDF from template: {}", templateName);

            context.setVariable("logoSrc", LOGO_URL);

            String htmlContent = templateEngine.process(String.valueOf(new ClassPath("pdf/" + templateName)), context);
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();

            ITextRenderer renderer = new ITextRenderer();
            renderer.setDocumentFromString(htmlContent);
            renderer.layout();
            renderer.createPDF(outputStream);

            logger.info("PDF generated successfully");
            return outputStream.toByteArray();
        } catch (Exception e) {
            logger.error("Error generating PDF", e);
            throw e;
        }
    }

}
